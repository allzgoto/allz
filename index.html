<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shadow Fight — Cinematic</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; background: #000; overflow: hidden; }

    .stage {
      position: relative;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, #0b0b0b 0%, #000 70%);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Vídeo principal (fundo) */
    .bg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 450ms ease;
      background: #000;
      z-index: 1;
    }
    .bg.is-active { opacity: 1; }

    /* Intro com portal */
    .intro {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 450ms ease;
      z-index: 2;
    }
    .intro.is-hidden { opacity: 0; pointer-events: none; }

    /* Portal central */
    .portal {
      width: min(320px, 70vw);
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      overflow: hidden;
      cursor: pointer;
      position: relative;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow:
        0 0 30px rgba(255,255,255,0.08),
        0 0 80px rgba(255,255,255,0.04);
      transform: translateZ(0);
      transition: transform 220ms ease, box-shadow 220ms ease, border-color 220ms ease;
    }
    .portal:hover {
      transform: scale(1.02);
      border-color: rgba(255,255,255,0.22);
      box-shadow:
        0 0 45px rgba(255,255,255,0.12),
        0 0 110px rgba(255,255,255,0.06);
    }

    .portal video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .vignette {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 3;
      background: radial-gradient(circle at center, rgba(0,0,0,0) 40%, rgba(0,0,0,0.65) 100%);
    }

    .noselect { user-select: none; -webkit-user-select: none; }
  </style>
</head>

<body>
  <main class="stage noselect">
    <video
      id="mainVideo"
      class="bg"
      src="https://files.catbox.moe/klaol5.webm"
      playsinline
      preload="auto"
    ></video>

    <section id="intro" class="intro">
      <div id="portal" class="portal" role="button" tabindex="0" aria-label="Ativar portal">
        <video
          id="portalVideo"
          src="https://files.catbox.moe/5ci6gd.mp4"
          playsinline
          preload="auto"
          muted
        ></video>
      </div>
    </section>

    <div class="vignette"></div>
  </main>

  <script>
    const intro = document.getElementById("intro");
    const portal = document.getElementById("portal");
    const portalVideo = document.getElementById("portalVideo");
    const mainVideo = document.getElementById("mainVideo");

    let running = false;
    let fallbackArmed = false;

    function holdFirstFrame() {
      // deixa parado no frame 0
      try { portalVideo.currentTime = 0; } catch (e) {}
      portalVideo.pause();
    }

    // garante frame inicial assim que carregar dados
    portalVideo.addEventListener("loadeddata", holdFirstFrame, { once: true });

    function goToMainVideo() {
      intro.classList.add("is-hidden");

      mainVideo.classList.add("is-active");
      mainVideo.loop = true;

      mainVideo.play().catch(err => {
        console.warn("Play do vídeo principal falhou:", err);
      });

      // fullscreen (tentativa; pode falhar)
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen().catch(() => {});
    }

    function armFallbackEndCheck() {
      if (fallbackArmed) return;
      fallbackArmed = true;

      const tick = () => {
        if (!running) return;

        const d = portalVideo.duration;
        const t = portalVideo.currentTime;

        // quando estiver praticamente no fim, troca
        if (Number.isFinite(d) && d > 0 && t >= d - 0.08) {
          running = false;
          goToMainVideo();
          return;
        }

        requestAnimationFrame(tick);
      };

      requestAnimationFrame(tick);
    }

    async function startSequence() {
      if (running) return;
      running = true;

      // reseta e tenta tocar
      try { portalVideo.currentTime = 0; } catch (e) {}

      // se metadados ainda não chegaram, espera um pouquinho
      if (portalVideo.readyState < 2) {
        await new Promise(resolve => {
          const onReady = () => {
            portalVideo.removeEventListener("loadedmetadata", onReady);
            resolve();
          };
          portalVideo.addEventListener("loadedmetadata", onReady, { once: true });
        });
        try { portalVideo.currentTime = 0; } catch (e) {}
      }

      try {
        await portalVideo.play();
        armFallbackEndCheck();
      } catch (err) {
        // IMPORTANTÍSSIMO: se falhar, libera pra clicar de novo
        running = false;
        console.warn("Play do portal falhou:", err);
      }
    }

    // caminho ideal: ended
    portalVideo.addEventListener("ended", () => {
      if (!running) return;
      running = false;
      goToMainVideo();
    });

    portal.addEventListener("click", startSequence);
    portal.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        startSequence();
      }
    });
  </script>
</body>
</html>
